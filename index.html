<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Worker Attendance Portal</title>

  <style>
    :root{
      --primary:#1f2937;
      --accent:#2563eb;
      --bg:#f8fafc;
      --card:#ffffff;
      --present:#16a34a;
      --absent:#dc2626;
      --off:#6b7280;
      --ph:#9333ea;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    body{margin:0;background:var(--bg);color:var(--primary)}
    header{padding:1rem;text-align:center;font-weight:700;font-size:1.1rem}
    .container{max-width:1000px;margin:auto;padding:1rem}
    .search-box{display:flex;gap:.5rem;margin-bottom:1rem}
    input{flex:1;padding:.7rem;border-radius:.5rem;border:1px solid #d1d5db}
    button{padding:.7rem 1rem;border:none;border-radius:.5rem;background:var(--accent);color:#fff;font-weight:600}
    button:disabled{cursor:not-allowed}
    .card{background:var(--card);border-radius:1rem;padding:1rem;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .info{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1rem}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:.5rem}
    .day{padding:.6rem;border-radius:.5rem;text-align:center;font-size:.75rem}
    .present{background:#dcfce7;color:var(--present)}
    .absent{background:#fee2e2;color:var(--absent)}
    .off{background:#e5e7eb;color:var(--off)}
    .ph{background:#f3e8ff;color:var(--ph)}
    @media(max-width:600px){.info{grid-template-columns:1fr}}
  </style>
</head>

<body>
<header>Worker Attendance Portal</header>

<div class="container">
  <div class="search-box">
    <input id="search" placeholder="Enter Employee Name or ID" />
    <button onclick="loadAttendance()">Search</button>
  </div>

  <div id="result"></div>
</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vRCyyGKd5jgqvz7mUUCI1DNPjMWC4CW4IZ_mfCSGRtCs7bBT0vma4zKZWwcx4Z9W9cSixg7mlji23ia/pub?gid=736929992&single=true&output=csv";

async function loadAttendance(){
  const key = document.getElementById('search').value.trim().toLowerCase();
  if(!key) return;

  const res = await fetch(CSV_URL);
  const text = await res.text();
  const rows = text.split('\n').map(r=>r.split(','));

  const empIdRow = rows.find(r => r[0]==='Employee ID');
  const nameRow  = rows.find(r => r[0]==='Name');
  const desigRow = rows.find(r => r[0]==='Designation');

  let colIndex = -1;
  for(let i=1;i<empIdRow.length;i++){
    if(
      empIdRow[i].toLowerCase().includes(key) ||
      nameRow[i].toLowerCase().includes(key)
    ){
      colIndex = i;
      break;
    }
  }

  if(colIndex === -1){
    document.getElementById('result').innerHTML = '<p>No record found</p>';
    return;
  }

  let html = `<div class="card">
    <div class="info">
      <div><strong>Name:</strong> ${nameRow[colIndex]}</div>
      <div><strong>Employee ID:</strong> ${empIdRow[colIndex]}</div>
      <div><strong>Designation:</strong> ${desigRow[colIndex]}</div>
    </div>
    <div class="calendar">`;

  rows.forEach(r=>{
    if(r[0].includes('Jan')){
      const val = r[colIndex];
      let cls = 'absent';
      if(val.includes('PH')) cls='ph';
      else if(val.includes('WO')) cls='off';
      else if(parseInt(val)>0) cls='present';

      html += `<div class="day ${cls}">
        <div>${r[0]}</div>
        <div>${val}</div>
      </div>`;
    }
  });

  html += '</div></div>';

  // SUMMARY TABLE
  let summaryHtml = `
  <div class="card" style="margin-top:1rem">
    <h4>Attendance Summary</h4>
    <table style="width:100%;font-size:.85rem;border-collapse:collapse">`;

  const summaryRows = [
    'Present Days',
    'Public Holiday',
    'Casual Leave',
    'Earned Leave',
    'Weekoffs',
    'LOP/Absent Days',
    'Final Present Days',
    'OT Hours'
  ];

  summaryRows.forEach(label=>{
    const row = rows.find(r=>r[0]===label);
    if(row){
      summaryHtml += `
      <tr>
        <td style="padding:.4rem;border-bottom:1px solid #e5e7eb">${label}</td>
        <td style="padding:.4rem;border-bottom:1px solid #e5e7eb;text-align:right">
          ${row[colIndex]}
        </td>
      </tr>`;
    }
  });

  summaryHtml += `
    </table>
    <button id="downloadBtn" onclick="downloadCard()" style="margin-top:.7rem;width:100%">
      Download Attendance Card
    </button>
  </div>`;

  document.getElementById('result').innerHTML = html + summaryHtml;
}

// DOWNLOAD FUNCTION (FIXED)
function downloadCard(){
  const btn = document.getElementById('downloadBtn');
  if(!btn || btn.disabled) return;

  btn.disabled = true;
  btn.style.opacity = '0.7';
  btn.innerText = 'Preparing Download...';

  setTimeout(() => {
    window.print();   // Reliable PDF download
    btn.innerText = 'Downloaded';
  }, 300);
}
</script>
</body>
</html>
